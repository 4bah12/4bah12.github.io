<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #adminInterface { display: none; }
    #mainMapContainer, #recMapContainer { 
      position: relative; 
      display: inline-block; 
      border: 1px solid #ccc; 
      margin: 10px; 
    }
    #mainMapCanvas, #recMapCanvas { position: absolute; top: 0; left: 0; }
    select, button, input { margin: 5px; padding: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <!-- Admin Login Form -->
  <div id="loginForm">
    <h1>Admin Login</h1>
    <p>Enter admin code:</p>
    <input type="password" id="adminCodeInput" placeholder="Enter code">
    <button onclick="checkAdminCode()">Login</button>
    <p id="loginError" style="color: red;"></p>
  </div>
  
  <!-- Admin Interface (shown after successful login) -->
  <div id="adminInterface">
    <h1>Admin Panel</h1>
    <p>Manage the main map and view recommendations.</p>
    
    <!-- Main Map Display -->
    <h2>Main Map</h2>
    <div id="mainMapContainer">
      <img id="mainMapImage" src="cohasset_map.png" alt="Town Map">
      <canvas id="mainMapCanvas"></canvas>
    </div>
    <br>
    <button onclick="refreshMainMap()">Refresh Main Map</button>
    
    <!-- Recommendations Display -->
    <h2>Recommendations</h2>
    <select id="recSelect" onchange="drawRecMap()">
      <!-- Options populated by script -->
    </select>
    <br>
    <div id="recMapContainer">
      <img id="recMapImage" src="cohasset_map.png" alt="Town Map">
      <canvas id="recMapCanvas"></canvas>
    </div>
    <br>
    <button onclick="applyRecommendation()">Apply Selected Recommendation</button>
    <button onclick="clearRecommendations()">Clear Recommendations</button>
  </div>
  
  <script>
    // Obfuscated admin code (Base64 for "12903478")
    const obfuscatedCode = "MTI5MDM0Nzg=";
    function decodeBase64(str) {
      try { return atob(str); } catch(e) { return ""; }
    }
    
    function checkAdminCode() {
      const inputCode = document.getElementById("adminCodeInput").value;
      const correctCode = decodeBase64(obfuscatedCode);
      if (inputCode === correctCode) {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("adminInterface").style.display = "block";
        loadRecommendations();
        refreshMainMap();
        refreshRecMap(); // Initialize recommendation canvas
      } else {
        document.getElementById("loginError").textContent = "Incorrect code!";
      }
    }
    
    // === Main Map Section ===
    const mainImg = document.getElementById("mainMapImage");
    const mainCanvas = document.getElementById("mainMapCanvas");
    const mainCtx = mainCanvas.getContext("2d");
    function resizeMainCanvas() {
      mainCanvas.width = mainImg.width;
      mainCanvas.height = mainImg.height;
      drawMainMap();
    }
    mainImg.onload = resizeMainCanvas;
    function getMainMap() {
      const data = localStorage.getItem("mainMap");
      if(data) {
        try { return JSON.parse(data); } catch(e) { return []; }
      }
      return [];
    }
    function drawMainMap() {
      mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
      const territories = getMainMap();
      territories.forEach(polygon => {
        mainCtx.fillStyle = polygon.color + "66"; // semi-transparent fill
        mainCtx.strokeStyle = polygon.color;
        mainCtx.lineWidth = 2;
        mainCtx.beginPath();
        polygon.points.forEach((pt, idx) => {
          if (idx === 0) mainCtx.moveTo(pt.x, pt.y);
          else mainCtx.lineTo(pt.x, pt.y);
        });
        mainCtx.closePath();
        mainCtx.fill();
        mainCtx.stroke();
      });
    }
    function refreshMainMap() {
      resizeMainCanvas();
    }
    
    // === Recommendation Map Section ===
    const recImg = document.getElementById("recMapImage");
    const recCanvas = document.getElementById("recMapCanvas");
    const recCtx = recCanvas.getContext("2d");
    function resizeRecCanvas() {
      recCanvas.width = recImg.width;
      recCanvas.height = recImg.height;
    }
    recImg.onload = resizeRecCanvas;
    
    // Load recommendations from localStorage and populate the select element
    function loadRecommendations() {
      const recSelect = document.getElementById("recSelect");
      recSelect.innerHTML = "";
      let recData = localStorage.getItem("recommendations");
      let recs = [];
      if(recData) {
        try { recs = JSON.parse(recData); } catch(e) { recs = []; }
      }
      for (let i = 0; i < recs.length; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = "Recommendation " + (i + 1);
        recSelect.appendChild(option);
      }
      // Draw the first recommendation if available
      drawRecMap();
    }
    
    // Draw the selected recommendation on the recommendation canvas
    function drawRecMap() {
      recCtx.clearRect(0, 0, recCanvas.width, recCanvas.height);
      const recSelect = document.getElementById("recSelect");
      let recData = localStorage.getItem("recommendations");
      let recs = [];
      if(recData) {
        try { recs = JSON.parse(recData); } catch(e) { recs = []; }
      }
      const index = recSelect.value;
      if (recs.length > index) {
        const recommendation = recs[index];
        recommendation.forEach(polygon => {
          recCtx.fillStyle = polygon.color + "66";
          recCtx.strokeStyle = polygon.color;
          recCtx.lineWidth = 2;
          recCtx.beginPath();
          polygon.points.forEach((pt, idx) => {
            if (idx === 0) recCtx.moveTo(pt.x, pt.y);
            else recCtx.lineTo(pt.x, pt.y);
          });
          recCtx.closePath();
          recCtx.fill();
          recCtx.stroke();
        });
      }
    }
    
    function refreshRecMap() {
      resizeRecCanvas();
      drawRecMap();
    }
    
    // Apply the selected recommendation as the main map
    function applyRecommendation() {
      const recSelect = document.getElementById("recSelect");
      const index = recSelect.value;
      let recData = localStorage.getItem("recommendations");
      let recs = [];
      if(recData) {
        try { recs = JSON.parse(recData); } catch(e) { recs = []; }
      }
      if (recs.length > index) {
        localStorage.setItem("mainMap", JSON.stringify(recs[index]));
        alert("Recommendation applied to Main Map.");
        refreshMainMap();
      }
    }
    
    function clearRecommendations() {
      localStorage.removeItem("recommendations");
      loadRecommendations();
      alert("Recommendations cleared.");
      recCtx.clearRect(0, 0, recCanvas.width, recCanvas.height);
    }
  </script>
</body>
</html>
